---
title: "Assignment 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggcorrplot)
require(ggplot2)

shower_data <- read.csv2("shower_data.csv")
survey_data <- read.csv2("shower_survey_data.csv")
```

## Exercise a)

Before you start to build the model, you need to derive the energy consumption
from the given parameters and preprocess the data. The energy use [kWh] per
shower can be estimated using the following formula (neglecting units); we
assume a cold water temperature of 12 degrees and an average water heating
efficiency of 65%.

```{r}
shower_data <- mutate(shower_data, energy = Volume * (Avgtemperature - 12/0.65) * (4.184 / 3600))
```

## Exercise b)

Remove showers with a negative energy consumption. Moreover,
identify and remove outliers on the dependent variable, if they exist.
Justify your choice.

```{r}
shower_data <- filter(shower_data, energy >= 0)

plot(shower_data$Shower, shower_data$energy)

outliers <- boxplot.stats(shower_data$energy)$out

energy_without_outliers <- shower_data$energy[!shower_data$energy %in% boxplot.stats(shower_data$energy)$out]

####### Winsorizing #######
#qnt <- quantile(shower_data$energy, probs=c(.25, .75), na.rm = T)
#caps <- quantile(shower_data$energy, probs=c(.05, .95), na.rm = T)
#H <- 1.5 * IQR(shower_data$energy, na.rm = T)
#shower_data$energy[shower_data$energy < (qnt[1] - H)] <- caps[1]
#shower_data$energy[shower_data$energy > (qnt[2] + H)] <- caps[2]

qnt <- quantile(shower_data$energy, probs=c(.10, .90), na.rm = T)
H <- 1.5 * IQR(shower_data$energy, na.rm = T)
shower_data$energy[shower_data$energy < (qnt[1] - H)] <- NA
shower_data$energy[shower_data$energy > (qnt[2] + H)] <- NA
```

## Exercise c)

Estimate the energy savings using a difference-in-difference (DiD)
model; do not include items from the questionnaire. Then, interpret
the estimated values of the DiD model. Do the values reflect what one
would expect from a successful randomization?

```{r}
baseline <- shower_data %>% filter(Shower < 10)
intervention <- shower_data %>% filter(Shower >= 10)

baseline_treatment <- baseline %>% filter(group > 2)
baseline_control <- baseline %>% filter(group <= 2)
intervention_treatment <- intervention %>% filter(group > 2)
intervention_control <- intervention %>% filter(group <= 2)

avg_intervention_treatment <- intervention_treatment %>% summarise(avgEnergy = mean(energy))
avg_intervention_control <- intervention_control %>% summarise(avgEnergy = mean(energy))
avg_baseline_treatment <- baseline_treatment %>% summarise(avgEnergy = mean(energy))
avg_baseline_control <- baseline_control %>% summarise(avgEnergy = mean(energy))

# Add dummy variable for intervention phase
shower_data <- shower_data %>% mutate(intervention = ifelse(Shower < 10, 0, ifelse(Shower >= 10, 1, NA)))

# Add dummy variable for treatment group
shower_data <- shower_data %>% mutate(treatment = ifelse(group <= 2, 0, ifelse(group > 2, 1, NA)))

model <- lm(energy ~ Volume + treatment + intervention + treatment * intervention, data = shower_data)
```

## Exercise d)

Now extend the basic model by including the following variables as
interacting variables of your DiD model. Please add each of the
following variables separately to the basic model
(i. e., first step: DiD with Baseline, second step: DiD with Age, .).
- Baseline Consumption
- Age
- Long hair (0=no)
- Environmental attitude (att5: "ich verhalte mich auch dann
umweltbewusst, wenn es erheblich höhere Kosten und Mühen
verursacht"; 5 = strong agreement)
Which variables have a statistically significant influence on the saving
effects?

```{r}
joined_data <- inner_join(shower_data, survey_data, by = "Hh_ID")
sumVolume <- joined_data %>% filter(intervention == 0) %>% group_by(Hh_ID) %>% summarize(baseline_consumption = sum(Volume))
joined_data <- inner_join(joined_data, sumVolume, by = "Hh_ID")

model1 <- lm(energy ~ Volume + baseline_consumption + treatment + intervention + treatment * intervention, data = joined_data)
AIC(model1)
model2 <- lm(energy ~ Volume + alter + treatment + intervention + treatment * intervention, data = joined_data)
AIC(model2)

joined_data <- joined_data %>% mutate(long_hair = ifelse(X03d_longhair >= 1, "Yes", ifelse(X03d_longhair == 0, "No", NA)))
model3 <- lm(energy ~ Volume + long_hair + treatment + intervention + treatment * intervention, data = joined_data)
AIC(model3)

model4 <- lm(energy ~ Volume + att5 + treatment + intervention + treatment * intervention, data = joined_data)
AIC(model4)
```

## Exercise e)

```{r}
model5 <- lm(energy ~ Volume + baseline_consumption + alter + long_hair + att5 + treatment + intervention + treatment * intervention, data = joined_data)

barplot(t(summary(model5)$coefficients), main = "Barplot")
```

## Exercise f)

```{r}
# Treatmentgruppe der nicht Umweltbewussten sparten mehr Wasser
test <- joined_data %>% filter(att5 == "Stimme nicht zu")
model6 <- lm(energy ~ Volume + treatment + intervention + treatment * intervention, data = test)

test2 <- joined_data %>% filter(att5 == "Stimme zu")
model7 <- lm(energy ~ Volume + treatment + intervention + treatment * intervention, data = test2)

test3 <- joined_data %>% group_by(Hh_ID) %>% summarize(avg_showertime = mean(Showertime))
test4 <- inner_join(joined_data, test3)
test5 <- test4 %>% mutate(clean_people = ifelse(avg_showertime >= mean(test3$avg_showertime), 1, ifelse(avg_showertime < mean(test3$avg_showertime), 0, NA)))
test6 <- test5 %>% filter(clean_people == 1)
test7 <- test5 %>% filter(clean_people == 0)

# Langeduscher haben in der Intervention phase kürzer geduscht
model8 <- lm(energy ~ Volume + avg_showertime + treatment + intervention + treatment * intervention, data = test6)
model9 <- lm(energy ~ Volume + avg_showertime + treatment + intervention + treatment * intervention, data = test7)

# Einzelperson wird signifikanter. Bei Beibehalten der Randomisierung, kaum Unterschied.
```